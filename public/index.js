var Q=(I)=>{const w={},K=I?.cookie;if(!K)return w;return K.split(";").forEach(function(x){let[j,...C]=x.split("=");if(j=j?.trim(),!j)return;const F=C.join("=").trim();if(!F)return;w[j]=decodeURIComponent(F)}),w},R=(I)=>{var w=0,K,x;if(I.length===0)return w;for(K=0;K<I.length;K++)x=I.charCodeAt(K),w=(w<<5)-w+x,w|=0;return w};var N=async(I="",w=null)=>{if(w)w=Object.entries(w).map(([j,C])=>`${j}=${C}`).join("; ");const K=await fetch("https://chicago-beyond.vercel.thisismess.io"+I,{headers:{cookie:w}}),x=K.headers.get("content-type");if(x&&x.includes("text/html"))return await K.text();return K};import{Database as Z} from"bun:sqlite";var $=new Z(":memory:"),_=$.query("CREATE TABLE pages (hash integer PRIMARY KEY, html text NOT NULL, date integer NOT NULL, slug text NOT NULL);").run(),z=$.prepare("INSERT INTO pages (hash, html, date, slug) VALUES ($hash, $html, $date, $slug)"),U=$.transaction((I)=>{for(let w of I)z.run(w)}),L=$.prepare("UPDATE pages SET html = $html, date = $date WHERE hash = $hash"),V=$.transaction((I)=>{for(let w of I)L.run(w)}),S=$.prepare("DELETE FROM pages WHERE slug = $slug"),W=$.transaction((I)=>{for(let w of I)S.run({$slug:w})}),v=$.prepare("DELETE FROM pages"),O=()=>{O.run()},X=(I)=>{return $.query("SELECT * FROM pages where hash = $hash;").get({$hash:I})};var f=Bun.serve({async fetch(I){const w=JSON.parse(JSON.stringify(I.headers)),K=Q(w),x=new URL(I.url);if(x.searchParams.has("refresh")){const E=x.searchParams.get("refresh");if(E==="all")O();else if(E==="slug"){const J=x.pathname+x.hash+x.search;W([J])}}const C=R(x+JSON.stringify(K)),F=X(C);let G;if(!F){const E=await N(x.pathname+x.hash+x.search,K);if(E instanceof Response)return E;G=E;const J=[{$hash:C,$html:G,$date:Date.now(),$slug:x.pathname+x.hash+x.search}];U(J)}else if(Date.now()-F.date>86400000){console.log("expired"),G=await N(x.pathname+x.hash+x.search,K);const Y=[{$hash:C,$html:G,$date:Date.now()}];V(Y)}else G=F.html;return new Response(G,{status:200,headers:{"Content-Type":"text/html"}})},port:443});console.log(`Listening on http://localhost:${f.port} ...`);
